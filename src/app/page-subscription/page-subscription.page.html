<ion-header>
  <ion-toolbar>
    <ion-title>Inscrição</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/eventos"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="majorEvent$| async as majorEvent; else loading">
    <div class="event-container">
      <ion-card-header>
        <ion-card-title>{{majorEvent.name}}</ion-card-title>
      </ion-card-header>

      <ion-card-content *ngIf="majorEvent.description">
        <p class="ion-text-justify event-description">{{majorEvent.description}}</p>
      </ion-card-content>

      <div class="card-section ion-padding-horizontal">
        <div class="card-label">
          <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          Datas
        </div>

        <ion-item lines="none">
          Evento
          <span slot="end">
            {{ getDateFromTimestamp(majorEvent.eventStartDate) | date: 'dd/MM' }} {{ majorEvent.eventEndDate && '- ' +
            (getDateFromTimestamp(majorEvent.eventEndDate) | date: 'dd/MM') }}
          </span>
        </ion-item>

        <ion-item lines="none" *ngIf="majorEvent.subscriptionStartDate && majorEvent.subscriptionEndDate">
          Inscrição
          <span slot="end">
            {{ getDateFromTimestamp(majorEvent.subscriptionStartDate) | date: 'dd/MM' }} {{
            majorEvent.subscriptionEndDate && '- ' + (getDateFromTimestamp(majorEvent.subscriptionEndDate) | date:
            'dd/MM') }}
          </span>
        </ion-item>
      </div>

      <div class="card-section ion-padding-horizontal" *ngIf="majorEvent.price">
        <div class="card-label">
          <ion-icon name="wallet-outline" aria-hidden="true"></ion-icon>
          Valores
        </div>

        <ng-container *ngIf="majorEvent.price.isFree; else notFree">
          <ion-item lines="none">
            <ion-label>Gratuito</ion-label>
          </ion-item>
        </ng-container>

        <ng-template #notFree>
          <ng-container *ngIf="majorEvent.price.single; then singlePrice else multiPrice"> </ng-container>
        </ng-template>

        <ng-template #singlePrice>
          <ion-item lines="none">
            Preço único
            <span slot="end">{{ majorEvent.price.single | currency:'BRL' }}</span>
          </ion-item>
        </ng-template>

        <ng-template #multiPrice>
          <ion-item lines="none" *ngIf="majorEvent.price.students">
            Alunos da Unesp
            <span slot="end">{{ majorEvent.price.students | currency:'BRL' }}</span>
          </ion-item>

          <ion-item lines="none" *ngIf="majorEvent.price.otherStudents">
            Alunos
            <span slot="end">{{ majorEvent.price.otherStudents | currency:'BRL' }}</span>
          </ion-item>

          <ion-item lines="none" *ngIf="majorEvent.price.professors">
            Professores
            <span slot="end">{{ majorEvent.price.professors | currency:'BRL' }}</span>
          </ion-item>
        </ng-template>
      </div>

      <div class="card-section ion-padding-horizontal">
        <ion-item>
          <ion-label>Tipo de inscrição</ion-label>
          <ion-select interface="popover" placeholder="Selecionar" [(ngModel)]="opSelected">
            <ion-select-option value="0">Aluno da Unesp</ion-select-option>
            <ion-select-option value="1">Aluno de outras IES</ion-select-option>
            <ion-select-option value="2">Professores e profissionais</ion-select-option>
          </ion-select>
        </ion-item>

        <p *ngIf="majorEvent.maxCourses && majorEvent.maxCourses > 0">
          {{ coursesSelected | number: '2.0-0' }} de {{ majorEvent.maxCourses | number: '2.0-0' }} minicursos
          selecionados
        </p>
        <p *ngIf="majorEvent.maxLectures && majorEvent.maxLectures > 0">
          {{ lecturesSelected | number: '2.0-0' }} de {{ majorEvent.maxLectures | number: '2.0-0' }} palestras
          selecionados
        </p>
      </div>

      <ng-container *ngIf="events$ | async as eventsArray; else loadingSpinner">
        <ng-container *ngFor="let event of eventsArray; index as i">
          <ion-item-divider
            mode="ios"
            sticky="true"
            *ngIf="i == 0 || !dayCompare(eventsArray[i - 1].eventStartDate, event.eventStartDate)">
            <ion-label> {{ formatDate(getDateFromTimestamp(event.eventStartDate)) }} </ion-label>
          </ion-item-divider>

          <ion-list>
            <ion-item>
              <ion-avatar slot="start">
                <img src="assets/events/icon.png" />
              </ion-avatar>
              <ion-label>
                <h3>{{ event.name }}</h3>
                <h4>
                  {{ (getDateFromTimestamp(event.eventStartDate) | date: 'HH:mm') }} {{ event.eventEndDate && ' às ' +
                  (getDateFromTimestamp(event.eventEndDate) | date: 'dd/MM') }}
                </h4>
                <p>{{ event.slotsAvailable }} vagas restantes</p>
                <p>Sua posição na fila: {{ event.numberOfSubscriptions + 1 | number: '1.0-0' }}</p>
                <!-- <p>Conflito de horário com "item 2"</p>-->
              </ion-label>
              <ion-checkbox
                name="{{event.eventType}}"
                [disabled]="event.slotsAvailable === 0 ? true : null"
                [id]="event.id"
                slot="end"
                (ionChange)="countCheckeds($event, event)"></ion-checkbox>
            </ion-item>
          </ion-list>
        </ng-container>
      </ng-container>
    </div>
  </ng-container>

  <ng-template #loading>
    <ion-progress-bar type="indeterminate"></ion-progress-bar>
  </ng-template>

  <ng-template #loadingSpinner>
    <ion-spinner name="dots" style="margin: 0 auto; display: block"></ion-spinner>
  </ng-template>
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button
      (click)="onSubmit()"
      [disabled]="coursesSelected + lecturesSelected === 0 || opSelected === undefined">
      <ion-icon name="checkmark"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<swal
  #maxChanged
  title="As informações do evento foram atualizadas"
  text="Por favor, selecione os itens novamente"
  icon="warning"
  [heightAuto]="false"
  [showCancelButton]="false"
  [showCloseButton]="false"
  [showConfirmButton]="true"></swal>
