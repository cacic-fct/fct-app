<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="area-restrita/gerenciar-grandes-eventos/{{eventID}}/gerenciar-certificados">
      </ion-back-button>
    </ion-buttons>
    <ion-title>Emissão de certificados</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="event$ | async as event">
    <h1 class="ion-padding-horizontal">{{ event.name }}</h1>
  </ng-container>

  <form [formGroup]="dataForm">
    <ion-list>
      <div class="ion-padding-vertical">
        <ion-item>
          <ion-label>Tipo da emissão</ion-label>
          <ion-select formControlName="issueType" (ionChange)="issueToggleChange()">
            <ion-select-option value="batch"> Emissão em massa </ion-select-option>
            <ion-select-option value="list" disabled=""> Emissão por listagem manual </ion-select-option>
          </ion-select>
        </ion-item>

        <ng-container *ngIf="dataForm.get('issueType').value === 'batch'" formGroupName="batchIssue">
          <ion-item disabled="">
            <ion-label>Emitir para inscritos pagantes</ion-label>
            <ion-toggle formControlName="toPayer"> </ion-toggle>
            <ion-note slot="helper">Quem pagou, se inscreveu e esteve presente</ion-note>
          </ion-item>
          <ion-item disabled="">
            <ion-label>Emitir para pagantes não inscritos</ion-label>
            <ion-note slot="helper">Quem pagou, não se inscreveu no evento e teve presença coletada</ion-note>
            <ion-toggle formControlName="toNonSubscriber"> </ion-toggle>
          </ion-item>
          <ion-item disabled="">
            <ion-label>Emitir para não pagantes</ion-label>
            <ion-toggle formControlName="toNonPayer"> </ion-toggle>
            <ion-note slot="helper">Quem não pagou e teve presença coletada</ion-note>
          </ion-item>
        </ng-container>

        <ng-container *ngIf="dataForm.get('issueType').value === 'list'" formArrayName="issueList">
          <ion-item *ngFor="let person of getIssueList(); index as i" [formGroupName]="i">
            <ion-label>{{ i + 1 }}.</ion-label>
            <ion-label
              color="danger"
              style="padding-left: 8px"
              *ngIf="dataForm.get('issueList').get(i.toString()).errors?.notFound">
              Não encontrado
            </ion-label>
            <ion-input formControlName="userData" placeholder="E-mail, celular ou UID"> </ion-input>
            <ion-button fill="clear" color="danger" (click)="removeIssueList(i)">
              <ion-icon slot="icon-only" name="trash"> </ion-icon>
            </ion-button>
          </ion-item>
          <div class="ion-padding">
            <ion-button (click)="addToIssueList()">Adicionar</ion-button>
            <ion-button (click)="clearIssueListAlert()" color="danger">Limpar</ion-button>
          </div>
        </ng-container>
      </div>
      <ion-item>
        <ion-label class="ion-text-wrap">Nome do certificado a ser gerado</ion-label>
        <ion-input
          formControlName="certificateName"
          (ionChange)="formatCertificateID()"
          (ionBlur)="formatCertificateName()"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label>ID do certificado</ion-label>
        <ion-input tabindex="-1" color="medium" formControlName="certificateID" readonly></ion-input>
      </ion-item>

      <ion-item>
        <ion-label>Modelo do certificado</ion-label>
        <ion-select interface="popover" formControlName="certificateTemplate">
          <ng-container *ngFor="let certificateTemplate of certificateTemplates | keyvalue">
            <ion-select-option [value]="certificateTemplate.key">
              {{ certificateTemplate.value.displayName }}
            </ion-select-option>
          </ng-container>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>Data de emissão</ion-label>
        <ion-datetime-button datetime="issueDate"></ion-datetime-button>
      </ion-item>

      <ng-container formGroupName="participationType">
        <ion-item>
          <ion-label>Tipo de participação</ion-label>
          <ion-select interface="popover" formControlName="type">
            <ng-container *ngFor="let participationType of participationTypes | keyvalue">
              <ion-select-option *ngIf="!(participationType.key === 'custom')" [value]="participationType.key">
                {{ participationType.value }}
              </ion-select-option>
            </ng-container>
            <ion-select-option value="custom"> Personalizado </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item *ngIf="dataForm.get('participationType').value.type === 'custom'">
          <ion-label>Tipo de participação personalizado</ion-label>
          <ion-input placeholder="Escreva aqui" formControlName="custom"></ion-input>
        </ion-item>
      </ng-container>

      <ng-container formGroupName="eventType">
        <ion-item>
          <ion-label>Tipo de evento</ion-label>
          <ion-select interface="popover" formControlName="type">
            <ng-container *ngFor="let eventType of eventTypes | keyvalue">
              <ion-select-option *ngIf="!(eventType.key === 'custom')" [value]="eventType.key">
                {{ eventType.value }}
              </ion-select-option>
            </ng-container>
            <ion-select-option value="custom"> Personalizado </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item *ngIf="dataForm.get('eventType').value.type === 'custom'">
          <ion-label>Tipo de evento personalizado</ion-label>
          <ion-input placeholder="Escreva aqui" formControlName="custom"></ion-input>
        </ion-item>
      </ng-container>

      <ng-container>
        <ion-item>
          <ion-label>Texto complementar</ion-label>
          <ion-textarea placeholder="Escreva aqui" formControlName="extraText"></ion-textarea>
        </ion-item>
      </ng-container>

      <ng-container formGroupName="contentType">
        <ion-item>
          <ion-label>Conteúdo do evento</ion-label>
          <ion-select interface="popover" formControlName="type">
            <ng-container *ngFor="let contentType of contentTypes | keyvalue">
              <ion-select-option *ngIf="!(contentType.key === 'custom')" [value]="contentType.key">
                {{ contentType.value }}
              </ion-select-option>
            </ng-container>
            <ion-select-option value="custom"> Personalizado </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item *ngIf="dataForm.get('contentType').value.type === 'custom'">
          <ion-label>Conteúdo personalizado</ion-label>
          <ion-textarea placeholder="Escreva aqui" formControlName="custom"></ion-textarea>
        </ion-item>
      </ng-container>
    </ion-list>

    <div class="ion-padding-bottom">
      <ion-button class="ion-padding" type="submit" (click)="onSubmit()" [disabled]="!dataForm.valid">
        Emitir certificados
      </ion-button>
      <p style="font-size: 0.75em" class="ion-padding-horizontal">Ao continuar, confira os dados com atenção.</p>
    </div>

    <ion-modal [keepContentsMounted]="true">
      <ng-template>
        <ion-datetime id="issueDate" presentation="date-time" showDefaultButtons="true" formControlName="issueDate">
          <span slot="title">Selecione a data de emissão</span>
        </ion-datetime>
      </ng-template>
    </ion-modal>
  </form>

  <!-- <div>
    <ion-button (click)="autofill()">Auto-preencher</ion-button>
  </div> -->
</ion-content>

<swal
  #swalNotFound
  title="Evento não encontrado"
  icon="error"
  [heightAuto]="false"
  [showCancelButton]="false"
  [showCloseButton]="false"
  [showConfirmButton]="false">
</swal>
